# JPA Intro #
## Ocado @ Dzix ##
  
≈Åukasz Burdyna  

---

# ORM #
Object-Relational Mapping (ORM) is a technique that lets you query and manipulate data from a database using an object-oriented paradigm.

---

# JPA #

The Java Persistence API is a specification for: 
* accessing
* persisting
* managing 

data between Java objects / classes and a relational database 

---

# Just specification #
JPA itself is just a specification, not a product. It cannot perform any actions itself.  
JPA is just a set of interfaces and **requires an implementation**

---

# Provider #

In order to work with JPA a provider is needed.
Providers and their popularity:
* Hibernate ~72%
* EclipseLink ~13%
* OpenJpa ~2%
* other/none ~13%

(by [Vlad Mihalcea](https://twitter.com/vlad_mihalcea/status/764515904965279744?ref_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E764515904965279744&ref_url=https%3A%2F%2Fvladmihalcea.com%2Fjpa-providers-market-share-in-2016%2F) in 2016)

---

# Plain JPA #
![persistence.xml](persistenceFile.png)

---

# Spring with JPA #
Spring Data JPA makes it easy to easily implement JPA based repositories.  
This module deals with enhanced support for JPA based data access layers.

---

# POJO
```java
public class Author {

	private String firstName;
	private String lastName;

	// Constructors, getters and setters..
```
Note: JavaBean convention

---

## Entity ##

```java
@Entity 
public class Author {

	@Id 
	@GeneratedValue(strategy = GenerationType.AUTO)
	private Long id;

	private String firstName;
	private String lastName;

 	public Author() {
	}
	// Constructors, getters and setters..
```

Note:  A primary key field that is set by the application can have one of the following types:
    boolean, byte, short, char, int, long, float, double
    Byte, Short, Character, Integer, Long, Float, Double.
    math.BigInteger, math.BigDecimal, String,
    util.Date, sql.Date, sql.Time, sql.Timestamp.
    Any enum type.
    Reference to an entity object.

---

## SQL generated by Hibernate ##


```sql
Hibernate:
create table Author(
	id bigint generated by default as identity,
	firstName varchar(255),
	lastName varchar(255),
	primary key (id)
)
```

---

## Spring/Hibernate ddl-auto ##

```xml
spring.jpa.hibernate.ddl-auto=
```
* validate - validate the schema, makes no changes to the database
* update - update the schema
* create - creates the schema, destroying previous data
* create-drop - drop the schema at the end of the session

Note: schema.sql and data.sql
Migrations - Flyway or Liquibase

---

## Column definition ##

```java
@Table(name = "AUTHORS")
public class Author {
	@Enumerated(EnumType.STRING)
	private SomeEnum enumField;

	@Column(name = "last_name", 
		nullable = true, 
		unique = false, 
		insertable = true, 
		updatable = true, 
		length = 255)
	private String lastName;
```

---

## Field vs getter
```java
@Column(name = "SAMPLE_STRING")  
private String sampleString;

public String getSampleString(){  
  return sampleString;  
}
```
<!-- .element: class="fragment" data-fragment-index="0" -->
vs
<!-- .element: class="fragment" data-fragment-index="1" -->
```java
private String sampleString;

@Column(name = "SAMPLE_STRING")  
public String getSampleString(){  
  return sampleString;  
}  
```
<!-- .element: class="fragment" data-fragment-index="1" -->
Note: Use only one convention or use 
@AccessType(PROPERTY / FIELD)

---

## EntityManager ## 
EntityManager is the entry point for your entities.

* find
* persist
* merge
* refresh
* remove
* flush

Note: Refresh - refresh the state of the instance from the database, overwriting changes made to the entity, if any.

---

## Entity Transaction ##
```java
var transaction = entityManager.getTransaction();
transaction.begin();
transaction.commit();
transaction.rollback();
```
Spring
```java
@Transactional
```

---

## Managed vs detached entity ##

* Managed
* Detached

> image from the other presentation

Note: insert sth cos it's important

---

## Spring repositories ##

Interfaces to use with Spring Data:
* DontRemember
* PagedDontRemeber
* JpaRepository

---

## Inheritance ##

```java
@MappedSuperclass
@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@Inheritance(strategy = InheritanceType.JOINED)
```
Note: Mapped Superclass - only visible in JVM, derived entities are mapped to full tables along with superclass fields
Table per class - a single table is created for each entity with only it's fields
Single table - one table for every entity type (all fields in one table) - @DiscriminatorColumn @DiscriminatorValue
Joined - Superclass is mapped to a table, other entities have coresponding tables with specific fields

---

## Associations ##

```java
@OneToOne(cascade = Cascade, fetch = FetchType, mappedby = )
@OneToMany
@ManyToOne
@ManyToMany
```

---

## Cascade ##
* persist
* merge
* refresh
* remove
* detach
* all

---


## Fetch type ##
```java
fetch = FetchType.EAGER
fetch = FetchType.LAZY
```

---

```java
@JoinColumn
```

---

## Queries ##
JPQL

---

## Queries ##

* Spring Repository interface
* TypedQuery
* NamedQuery

